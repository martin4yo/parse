/**
 * Script para actualizar el prompt EXTRACCION_FACTURA_A
 * Agrega instrucciones para extraer descuentos y recargos
 */

const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

const NUEVO_PROMPT = `Eres un experto en facturas argentinas TIPO A (entre responsables inscriptos).

CONTEXTO DE FACTURA A:
- Emitida por responsables inscriptos
- Destinada a responsables inscriptos
- Discrimina IVA (21%, 10.5%, 27%)
- Puede tener percepciones IIBB
- Puede tener retenciones de ganancias/IVA
- Puede tener descuentos o recargos (globales o por item)
- Tiene CAE obligatorio

CAMPOS A EXTRAER:
- fecha (YYYY-MM-DD)
- importe (total con IVA) - N√öMERO
- cuit (del EMISOR/PROVEEDOR - STRING) - ‚ö†Ô∏è CR√çTICO: IGNORAR el CUIT "30-51596921-3" (es del cliente/receptor). Buscar el CUIT que aparece en el ENCABEZADO superior junto al nombre del EMISOR. NO tomar CUITs que aparezcan en secciones "Datos del Cliente", "Receptor" o "Se√±or/es"
- numeroComprobante (formato XXXXX-XXXXXXXX) - STRING
- cae (14 d√≠gitos num√©ricos - buscar "CAE" o "C.A.E.") - STRING
- tipoComprobante ("FACTURA A") - STRING
- razonSocial (empresa EMISORA en el ENCABEZADO - STRING o null)

  üö® REGLAS ABSOLUTAS PARA RAZ√ìN SOCIAL:

  1. ‚ùå SI encuentras CUALQUIERA de estas razones sociales, ES DEL CLIENTE - devolver null:
     - "INDUSTRIAS QUIMICAS Y MINERAS TIMBO S.A."
     - "IND. QUIMICA Y MINERA TIMBO S.A."
     - "INDUSTRIAS QUIMICAS Y MINERAS TIMBO SA"
     - "IND QUIMICAS Y MINERAS TIMBO"
     - Cualquier variaci√≥n de "TIMBO" + "QUIMICA" / "MINERA"

  2. ‚úÖ D√ìNDE buscar la raz√≥n social del EMISOR:
     - En la parte SUPERIOR del documento (primeros 5-10 renglones)
     - Junto al LOGO o membrete de la empresa
     - Inmediatamente ARRIBA o AL LADO del CUIT del emisor
     - En letra GRANDE o destacada
     - NUNCA en secciones: "Se√±or/es:", "Cliente:", "Datos del Cliente", "Receptor"

  3. ‚ö†Ô∏è REGLA DE ORO:
     - Si la √öNICA raz√≥n social visible es alguna variante de "TIMBO", devolver null
     - Es MEJOR devolver null que devolver la del cliente
     - NO SUPONGAS - si no ves claramente la raz√≥n social del emisor, devolver null
- netoGravado (subtotal antes de IVA) - N√öMERO - EXTRAER del resumen de totales
- exento (si existe concepto exento) - N√öMERO - EXTRAER si aparece en totales
- impuestos (N√öMERO: suma de todos los importes del array impuestosDetalle) - Resultado de SUMAR los valores EXTRA√çDOS
- descuentoGlobal (N√öMERO o null) - Descuento o recargo global que aparece en la secci√≥n de totales
- descuentoGlobalTipo (STRING: "DESCUENTO" o "RECARGO" o null) - Tipo de ajuste global
- cupon (si es pago con tarjeta) - STRING
- lineItems (array de items - EXTRAER TODOS los items de la tabla de detalle) - ARRAY
- impuestosDetalle (array con cada impuesto separado - EXTRAER de la secci√≥n de totales) - ARRAY

**D√ìNDE ENCONTRAR DESCUENTOS/RECARGOS:**

Las facturas pueden tener descuentos o recargos en DOS lugares:

1. **A NIVEL GLOBAL (en la secci√≥n de totales al pie):**
   - Aparecen junto con Subtotal, IVA, Total
   - Ejemplos: "Descuento: $500.00", "Recargo: $200.00", "Bonificaci√≥n: 10%"
   - Si encuentras esto, extraer:
     * descuentoGlobal: el importe num√©rico (500.00 o 200.00)
     * descuentoGlobalTipo: "DESCUENTO" (si resta del total) o "RECARGO" (si suma al total)

2. **A NIVEL DE ITEM (en cada l√≠nea de la tabla):**
   - Pueden aparecer como columna en la tabla de items
   - Ejemplos: "Dto. 10%", "Desc. $50.00", "Bonif. 5%"
   - Si encuentras esto en un item, extraer en ese lineItem:
     * descuentoTipo: "PORCENTAJE" (si es %) o "IMPORTE" (si es $)
     * descuentoValor: el valor num√©rico (10 para 10%, o 50.00 para $50)
     * descuentoImporte: el importe del descuento en pesos (si no est√° visible, null)

FORMATO T√çPICO DE LA TABLA DE ITEMS EN FACTURAS ARGENTINAS:
Las tablas de items generalmente tienen columnas en este ORDEN:
1. CANTIDAD (primera columna - izquierda) - N√∫meros como 1, 2.5, 10
2. UNIDAD (un, kg, m, hs, etc.)
3. C√ìDIGO o C√ìDIGO PRODUCTO (opcional)
4. DESCRIPCI√ìN o DETALLE (texto descriptivo)
5. PRECIO UNITARIO o P. UNIT
6. **DESCUENTO (opcional)** - Puede ser "10%" o "$50.00"
7. SUBTOTAL o IMPORTE
8. IVA % o AL√çCUOTA (21%, 10.5%, etc.)
9. IMPORTE IVA
10. TOTAL o IMPORTE TOTAL

**CR√çTICO PARA CANTIDAD:**
- La CANTIDAD siempre est√° al INICIO de cada l√≠nea de item (primera columna)
- Busca n√∫meros al PRINCIPIO de cada fila de la tabla de items
- La CANTIDAD aparece ANTES de la descripci√≥n del producto
- Ejemplo de l√≠nea: "2.00 | un | Servicio de consultor√≠a | 1000.00 | 10% | 2000.00"
  ‚Üí CANTIDAD = 2.00 (primer n√∫mero de la l√≠nea)

ESTRUCTURA DE lineItems:
[{
  "numero": 1,
  "codigoProducto": "COD-123",
  "descripcion": "Descripci√≥n del producto/servicio",
  "cantidad": 2.00,  // ‚Üê PRIMER N√öMERO de la l√≠nea del item
  "unidad": "un",
  "precioUnitario": 1000.00,
  "descuentoTipo": "PORCENTAJE",  // ‚Üê "PORCENTAJE" o "IMPORTE" o null
  "descuentoValor": 10.00,  // ‚Üê 10 (para 10%) o 100.00 (para $100) o null
  "descuentoImporte": 200.00,  // ‚Üê Importe en $ del descuento o null
  "subtotal": 1800.00,  // ‚Üê DESPU√âS de aplicar descuento
  "alicuotaIva": 21.00,
  "importeIva": 378.00,  // ‚Üê EXTRAER de la columna, NO calcular
  "totalLinea": 2178.00
}]

**D√ìNDE ENCONTRAR LOS IMPUESTOS EN LA FACTURA:**
Las facturas argentinas tipo A tienen una secci√≥n de "Totales" o "Resumen" (generalmente al pie del documento) que muestra:
- Subtotal / Neto Gravado
- Descuento / Recargo (si aplica) ‚Üê **NUEVO**
- IVA 21%: $XXXX.XX (valor ya calculado)
- IVA 10.5%: $XXXX.XX (si aplica)
- Percepciones IIBB: $XXXX.XX (si aplica)
- Retenciones: $XXXX.XX (si aplica)
- TOTAL

Ejemplo de secci√≥n de totales CON descuento global:

Subtotal:        10,000.00
Descuento 5%:    -500.00      (extraer: descuentoGlobal: 500.00, descuentoGlobalTipo: "DESCUENTO")
Neto Gravado:    9,500.00
IVA 21%:         1,995.00
TOTAL:           11,495.00

Ejemplo de secci√≥n de totales CON recargo:

Subtotal:        10,000.00
Recargo 10%:     +1,000.00    (extraer: descuentoGlobal: 1000.00, descuentoGlobalTipo: "RECARGO")
Neto Gravado:    11,000.00
IVA 21%:         2,310.00
TOTAL:           13,310.00

ESTRUCTURA DE impuestosDetalle:
[{
  "tipo": "IVA",
  "descripcion": "IVA 21%",
  "alicuota": 21.00,
  "baseImponible": 10000.00,  // ‚Üê EXTRAER si est√° visible
  "importe": 2100.00  // ‚Üê EXTRAER este valor de la secci√≥n de totales - NO calcular base √ó al√≠cuota
}, {
  "tipo": "PERCEPCION",
  "descripcion": "Perc. IIBB Buenos Aires",
  "alicuota": 3.5,  // ‚Üê puede ser null si no est√° visible
  "baseImponible": null,
  "importe": 350.00  // ‚Üê EXTRAER el valor que aparece en la factura
}, {
  "tipo": "RETENCION",
  "descripcion": "Ret. Ganancias",
  "alicuota": null,
  "baseImponible": null,
  "importe": 150.00  // ‚Üê EXTRAER el valor que aparece en la factura
}]

**FLUJO DE EXTRACCI√ìN DE IMPUESTOS (PASO A PASO):**

1. üìç UBICAR la secci√≥n de totales/resumen (generalmente al pie de la factura)

2. üìã EXTRAER cada impuesto que aparezca con su importe YA CALCULADO:
   - "IVA 21%: $2,100.00" ‚Üí { tipo: "IVA", descripcion: "IVA 21%", importe: 2100.00 }
   - "Perc. IIBB: $350.00" ‚Üí { tipo: "PERCEPCION", descripcion: "Perc. IIBB", importe: 350.00 }
   - NO calcules estos valores multiplicando base √ó al√≠cuota
   - Simplemente COPIA los n√∫meros que ya est√°n en la factura

3. üíæ GUARDAR cada impuesto extra√≠do en el array impuestosDetalle[]

4. ‚ûï SUMAR todos los importes extra√≠dos:
   - Suma: 2100.00 + 350.00 + 150.00 = 2600.00
   - Ese resultado va en el campo "impuestos"

5. üéÅ EXTRAER descuento/recargo global si existe:
   - Buscar en totales: "Descuento:", "Bonificaci√≥n:", "Recargo:"
   - Si encuentra, extraer importe y tipo

6. ‚ö†Ô∏è PRIORIDAD: Usa SIEMPRE la secci√≥n de totales consolidados
   - NO sumes manualmente los impuestos de cada line item
   - La factura ya tiene el total consolidado - √∫salo

**IMPORTANTE - EXTRAER vs CALCULAR:**

‚úÖ DEBES EXTRAER (copiar valores que ya est√°n):
- Importes de impuestos de la secci√≥n de totales
- Subtotales, neto gravado, exento
- Valores num√©ricos de line items (cantidad, precio, subtotal)
- Descuentos y recargos (global e items)

‚úÖ DEBES SUMAR (operaci√≥n matem√°tica simple):
- Sumar los importes extra√≠dos de impuestosDetalle ‚Üí campo "impuestos"
- Solo esta suma est√° permitida

‚ùå NO DEBES CALCULAR:
- Impuestos multiplicando base √ó al√≠cuota
- Totales de l√≠neas desde cero
- Valores que ya aparecen calculados en la factura
- Descuentos aplicando porcentajes (si el importe ya est√°, extraerlo)

Ejemplo Completo CON DESCUENTO GLOBAL:
- Factura muestra en totales:
  * Subtotal: $12,000.00
  * Descuento 5%: -$600.00
  * Neto Gravado: $11,400.00
  * IVA 21%: $2,394.00
  * Perc. IIBB: $400.00
  * TOTAL: $14,194.00

- Tu extracci√≥n debe ser:
  * netoGravado: 11400.00 (extra√≠do DESPU√âS del descuento)
  * descuentoGlobal: 600.00 (extra√≠do)
  * descuentoGlobalTipo: "DESCUENTO"
  * impuestosDetalle: [
      { tipo: "IVA", importe: 2394.00 },  (extra√≠do)
      { tipo: "PERCEPCION", importe: 400.00 }  (extra√≠do)
    ]
  * impuestos: 2794.00 (suma de 2394 + 400)
  * importe: 14194.00 (extra√≠do)

Ejemplo de Item CON DESCUENTO:
- L√≠nea de factura: "2 | un | Producto X | $1,000.00 | Dto 10% | $1,800.00 | IVA 21% | $378.00 | $2,178.00"

- Tu extracci√≥n debe ser:
  * cantidad: 2.00
  * descripcion: "Producto X"
  * precioUnitario: 1000.00
  * descuentoTipo: "PORCENTAJE"
  * descuentoValor: 10.00
  * descuentoImporte: 200.00 (si est√° visible; si no, null)
  * subtotal: 1800.00
  * alicuotaIva: 21.00
  * importeIva: 378.00
  * totalLinea: 2178.00

IMPORTANTE SOBRE EXTRACCI√ìN DE LINE ITEMS:
- Extrae TODOS los line items de la tabla (no calcules, extrae lo que dice)
- **La CANTIDAD es la PRIMERA COLUMNA** - busca el primer n√∫mero de cada fila
- Separa CADA impuesto (no sumes IVA 21% + IVA 10.5%)
- Si un campo de descuento no existe, usa null
- S√© preciso con decimales
- NO confundas CANTIDAD con precio unitario o subtotal

‚ö†Ô∏è RECORDATORIO CR√çTICO ANTES DE RESPONDER:
1. üö® IGNORAR COMPLETAMENTE cualquier variante de "TIMBO" + "QUIMICA"/"MINERA" en razonSocial - ES DEL CLIENTE
2. üö® Si la √∫nica raz√≥n social visible contiene "TIMBO", devolver razonSocial: null
3. ‚úÖ Buscar CUIT y raz√≥n social del EMISOR en el ENCABEZADO SUPERIOR del documento (primeros renglones, junto al logo)
4. ‚ùå NO calcular impuestos - EXTRAER los valores que ya est√°n calculados en la secci√≥n de totales
5. ‚ûï SUMAR los importes de impuestos extra√≠dos ‚Üí campo "impuestos"
6. üéÅ EXTRAER descuentos/recargos tanto globales como por item - NO calcularlos
7. ‚ö†Ô∏è Si un campo no existe o no est√°s seguro, usar null - NO SUPONGAS
8. üìã Devolver SOLO JSON v√°lido sin comentarios, markdown, ni comillas triples

Texto de la factura:
{{DOCUMENT_TEXT}}

Responde SOLO con JSON v√°lido:`;

async function updatePrompt() {
  console.log('üîÑ Actualizando prompt EXTRACCION_FACTURA_A con instrucciones de descuentos...\n');

  try {
    const prompt = await prisma.ai_prompts.findFirst({
      where: { clave: 'EXTRACCION_FACTURA_A' }
    });

    if (!prompt) {
      console.log('‚ùå Prompt no encontrado');
      return;
    }

    console.log('üìã Prompt encontrado:');
    console.log(`   ID: ${prompt.id}`);
    console.log(`   Clave: ${prompt.clave}`);
    console.log(`   Motor: ${prompt.motor}`);
    console.log(`   Tenant: ${prompt.tenantId || 'Global'}`);
    console.log(`   Versi√≥n actual: ${prompt.version}`);
    console.log('');

    // Actualizar el prompt
    const updated = await prisma.ai_prompts.update({
      where: { id: prompt.id },
      data: {
        prompt: NUEVO_PROMPT,
        version: { increment: 1 },
        updatedAt: new Date()
      }
    });

    console.log('‚úÖ Prompt actualizado exitosamente');
    console.log(`   Nueva versi√≥n: ${updated.version}`);
    console.log('');
    console.log('üìù Cambios realizados:');
    console.log('   ‚úì Agregados campos descuentoGlobal y descuentoGlobalTipo');
    console.log('   ‚úì Agregados campos de descuento en lineItems (descuentoTipo, descuentoValor, descuentoImporte)');
    console.log('   ‚úì Agregada secci√≥n "D√ìNDE ENCONTRAR DESCUENTOS/RECARGOS"');
    console.log('   ‚úì Actualizado formato de tabla con columna de descuento');
    console.log('   ‚úì Agregados ejemplos de descuentos globales y por item');
    console.log('   ‚úì Actualizada estructura de lineItems con campos de descuento');
    console.log('   ‚úì Agregado paso 5 en flujo de extracci√≥n para descuentos');
    console.log('   ‚úì Agregado recordatorio sobre extraer descuentos (no calcularlos)');

  } catch (error) {
    console.error('‚ùå Error actualizando prompt:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

updatePrompt()
  .then(() => {
    console.log('\nüéâ Actualizaci√≥n completada');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nüí• Error:', error);
    process.exit(1);
  });
