generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ai_prompts {
  id                 String    @id
  clave              String
  nombre             String
  descripcion        String?
  prompt             String    // Deprecated: Mantener para retrocompatibilidad
  systemPrompt       String?   // NUEVO: Instrucciones generales (va en API system parameter)
  userPromptTemplate String?   // NUEVO: Template del mensaje del usuario
  variables          Json?
  activo             Boolean   @default(true)
  version            Int       @default(1)
  motor              String?
  tipo               String?   @default("EXTRACTOR_SIMPLE")
  vecesUsado         Int       @default(0)
  ultimoUso          DateTime?
  tasaExito          Decimal?
  tenantId           String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  createdBy          String?
  updatedBy          String?
  tenants            tenants?  @relation(fields: [tenantId], references: [id])

  @@unique([clave, tenantId])
  @@index([activo])
  @@index([clave])
  @@index([motor])
  @@index([tenantId])
  @@index([tipo])
}

model ai_models {
  id          String   @id
  provider    String   @db.VarChar(50)
  modelId     String   @db.VarChar(100)
  name        String   @db.VarChar(100)
  description String?  @db.VarChar(500)
  recommended Boolean  @default(false)
  active      Boolean  @default(true)
  deprecated  Boolean  @default(false)
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([provider, modelId])
  @@index([provider])
  @@index([active])
  @@index([recommended])
}

model ai_provider_configs {
  id                        String   @id
  tenantId                  String?
  provider                  String
  apiKeyEncrypted           String?
  modelo                    String?
  maxRequestsPerDay         Int?
  config                    Json?    // Almacena { preprocessWithDocumentAI: true/false, ... }
  activo                    Boolean  @default(true)
  preprocessWithDocumentAI  Boolean  @default(false) // Pre-procesar con Document AI antes de IA
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime
  tenants                   tenants? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
  @@index([activo])
  @@index([provider])
  @@index([tenantId])
}

model atributos {
  id               String             @id
  codigo           String
  descripcion      String
  activo           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  tenantId         String?
  tenants          tenants?           @relation(fields: [tenantId], references: [id])
  valores_atributo valores_atributo[]

  @@unique([codigo, tenantId])
  @@index([activo])
  @@index([tenantId])
}

model documento_impuestos {
  id                       String                     @id
  documentoId              String
  tipo                     String                     @db.VarChar(50)
  descripcion              String                     @db.VarChar(200)
  alicuota                 Decimal?                   @db.Decimal(5, 2)
  baseImponible            Decimal?                   @db.Decimal(15, 2)
  importe                  Decimal                    @db.Decimal(15, 2)
  tenantId                 String
  createdAt                DateTime                   @default(now())
  codigoDimension          String?                    @db.VarChar(50)
  cuentaContable           String?                    @db.VarChar(50)
  subcuenta                String?                    @db.VarChar(50)
  camposEditadosManualmente Json?                     @default("{}")
  documento_distribuciones documento_distribuciones[]
  documentos_procesados    documentos_procesados      @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  tenants                  tenants                    @relation(fields: [tenantId], references: [id])

  @@index([documentoId])
  @@index([tenantId])
  @@index([tipo])
}

model documento_lineas {
  id                       String                     @id
  documentoId              String
  numero                   Int
  descripcion              String                     @db.VarChar(500)
  codigoProducto           String?                    @db.VarChar(100)
  cantidad                 Decimal                    @db.Decimal(10, 3)
  unidad                   String?                    @db.VarChar(100)
  precioUnitario           Decimal                    @db.Decimal(15, 4)
  subtotal                 Decimal                    @db.Decimal(15, 2)
  alicuotaIva              Decimal?                   @db.Decimal(5, 2)
  importeIva               Decimal?                   @db.Decimal(15, 2)
  totalLinea               Decimal                    @db.Decimal(15, 2)
  tenantId                 String
  createdAt                DateTime                   @default(now())
  descuentoImporte         Decimal?                   @db.Decimal(15, 2)
  descuentoTipo            String?                    @db.VarChar(20)
  descuentoValor           Decimal?                   @db.Decimal(15, 4)
  codigoDimension          String?                    @db.VarChar(50)
  cuentaContable           String?                    @db.VarChar(50)
  ordenCompra              String?                    @db.VarChar(50)
  subcuenta                String?                    @db.VarChar(50)
  tipoOrdenCompra          String?                    @db.VarChar(50)
  tipoProducto             String?                    @db.VarChar(50)
  codigoProductoOriginal   String?                    @db.VarChar(100)
  camposEditadosManualmente Json?                     @default("{}")
  documento_distribuciones documento_distribuciones[]
  documentos_procesados    documentos_procesados      @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  tenants                  tenants                    @relation(fields: [tenantId], references: [id])

  @@index([documentoId])
  @@index([tenantId])
}

model documentos_procesados {
  id                        String                     @id
  nombreArchivo             String
  tipoArchivo               String
  rutaArchivo               String
  fechaProcesamiento        DateTime                   @default(now())
  estadoProcesamiento       String                     @default("procesando")
  datosExtraidos            Json?
  fechaExtraida             DateTime?
  importeExtraido           Decimal?
  cuitExtraido              String?
  numeroComprobanteExtraido String?
  observaciones             String?
  usuarioId                 String
  tipo                      String                     @default("documento")
  tenantId                  String
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime
  caeExtraido               String?
  cuponExtraido             String?
  exentoExtraido            Decimal?
  netoGravadoExtraido       Decimal?
  impuestosExtraido         Decimal?
  razonSocialExtraida       String?
  tipoComprobanteExtraido   String?
  modeloIA                  String?
  exportado                 Boolean                    @default(false)
  fechaExportacion          DateTime?
  descuentoGlobalExtraido   Decimal?
  descuentoGlobalTipo       String?                    @db.VarChar(20)
  monedaExtraida            String?                    @db.VarChar(10)
  codigoProveedor           String?                    @db.VarChar(50)
  fechaReglasAplicadas      DateTime?
  reglasAplicadas           Boolean                    @default(false)
  errorMessage              String?
  codigoDimension           String?                    @db.VarChar(50)
  subcuenta                 String?                    @db.VarChar(50)
  validationErrors          Json?
  externalSystemId          String?                    @db.VarChar(100)
  lastExportedAt            DateTime?
  exportConfigId            String?
  documento_distribuciones  documento_distribuciones[]
  documento_impuestos       documento_impuestos[]
  documento_lineas          documento_lineas[]
  tenants                   tenants                    @relation(fields: [tenantId], references: [id])
  users                     users                      @relation(fields: [usuarioId], references: [id])

  @@index([tenantId])
  @@index([tipo])
  @@index([exportado])
  @@index([reglasAplicadas])
}

model menu_items {
  id                 String       @id
  parentId           String?
  title              String       @db.VarChar(100)
  icon               String       @db.VarChar(50)
  url                String?      @db.VarChar(255)
  description        String?      @db.VarChar(500)
  orderIndex         Int          @default(0)
  isActive           Boolean      @default(true)
  requiresPermission String?      @db.VarChar(100)
  superuserOnly      Boolean      @default(false)
  tenantId           String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime
  createdBy          String?
  updatedBy          String?
  menu_items         menu_items?  @relation("menu_itemsTomenu_items", fields: [parentId], references: [id], onDelete: Cascade)
  other_menu_items   menu_items[] @relation("menu_itemsTomenu_items")
  tenants            tenants?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([orderIndex])
  @@index([parentId])
  @@index([superuserOnly])
  @@index([tenantId])
}

model parametros_maestros {
  id              Int      @id @default(autoincrement())
  codigo          String
  nombre          String
  descripcion     String?
  tipo_campo      String
  valor_padre     String?
  orden           Int      @default(1)
  activo          Boolean  @default(true)
  tenantId        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  parametros_json Json?
  tenants         tenants? @relation(fields: [tenantId], references: [id])

  @@unique([tipo_campo, codigo, tenantId])
  @@index([tenantId])
}

model parametros_relaciones {
  id          Int      @id @default(autoincrement())
  campo_padre String
  campo_hijo  String
  descripcion String?
  activo      Boolean  @default(true)
  tenantId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  tenants     tenants? @relation(fields: [tenantId], references: [id])

  @@unique([campo_padre, campo_hijo, tenantId])
  @@index([tenantId])
}

model plan_features {
  id        String   @id
  planId    String
  feature   String
  config    Json?
  createdAt DateTime @default(now())
  planes    planes   @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, feature])
  @@index([feature])
  @@index([planId])
}

model planes {
  id            String          @id
  codigo        String          @unique
  nombre        String
  descripcion   String?
  precio        Decimal?        @db.Decimal(10, 2)
  activo        Boolean         @default(true)
  orden         Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  color         String?         @db.VarChar(20)
  plan_features plan_features[]
  tenants       tenants[]

  @@index([activo])
  @@index([codigo])
}

model processing_jobs {
  id             String    @id
  type           String
  status         String
  progress       Int       @default(0)
  totalItems     Int?
  processedItems Int?
  message        String?
  userId         String
  parameters     Json
  result         Json?
  error          String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime

  @@index([createdAt])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model profiles {
  id          String   @id
  codigo      String   @unique
  descripcion String
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  users       users[]
}

model reglas_ejecuciones {
  id             String         @id
  reglaId        String
  contexto       String
  entrada        Json
  salida         Json?
  exitosa        Boolean
  mensaje        String?
  duracionMs     Int?
  createdAt      DateTime       @default(now())
  reglas_negocio reglas_negocio @relation(fields: [reglaId], references: [id])

  @@index([contexto])
  @@index([createdAt])
  @@index([reglaId])
}

model reglas_negocio {
  id                     String                   @id
  codigo                 String
  nombre                 String
  descripcion            String?
  tipo                   String
  activa                 Boolean                  @default(true)
  prioridad              Int                      @default(100)
  version                Int                      @default(1)
  fechaVigencia          DateTime?
  configuracion          Json
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  createdBy              String?
  updatedBy              String?
  tenantId               String?
  esGlobal               Boolean                  @default(false)
  reglas_ejecuciones     reglas_ejecuciones[]
  tenants                tenants?                 @relation(fields: [tenantId], references: [id])
  sugerencias_ia         sugerencias_ia[]
  tenant_reglas_globales tenant_reglas_globales[]

  @@unique([codigo, tenantId])
  @@index([prioridad])
  @@index([tipo, activa])
  @@index([tenantId])
  @@index([esGlobal])
}

model sugerencias_ia {
  id             String         @id
  reglaId        String
  entidadTipo    String         @db.VarChar(50)
  entidadId      String
  campoDestino   String         @db.VarChar(100)
  textoAnalizado String
  valorSugerido  Json
  confianza      Decimal        @db.Decimal(3, 2)
  razon          String?
  estado         String         @default("pendiente") @db.VarChar(20)
  revisadoPor    String?
  revisadoAt     DateTime?
  valorFinal     Json?
  tenantId       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  reglas_negocio reglas_negocio @relation(fields: [reglaId], references: [id], onDelete: Cascade)
  users          users?         @relation(fields: [revisadoPor], references: [id])
  tenants        tenants?       @relation(fields: [tenantId], references: [id])

  @@index([estado])
  @@index([entidadTipo, entidadId])
  @@index([reglaId])
  @@index([tenantId])
  @@index([createdAt])
}

model sync_api_keys {
  id             String    @id
  tenantId       String
  nombre         String
  key            String    @unique
  keyPreview     String
  permisos       Json      @default("{}")
  activo         Boolean   @default(true)
  ultimoUso      DateTime?
  ultimoUsoIp    String?
  vecesUtilizada Int       @default(0)
  expiraEn       DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  createdBy      String?
  tenants        tenants   @relation(fields: [tenantId], references: [id])

  @@index([activo])
  @@index([key])
  @@index([tenantId])
}

// Logs de procesamiento de documentos via Parse API
model parse_api_logs {
  id                String    @id @default(uuid())
  tenantId          String
  apiKeyId          String?   // Referencia a sync_api_keys

  // Request
  operacion         String    @db.VarChar(50)  // parse, save, parse-and-save
  nombreArchivo     String?
  tipoArchivo       String?   @db.VarChar(20)
  tamanoBytes       Int?

  // Procesamiento
  estado            String    @db.VarChar(20)  // procesando, completado, error
  modeloIA          String?   @db.VarChar(50)
  confianza         Decimal?
  tipoDocumento     String?   @db.VarChar(50)

  // Resultado
  documentoId       String?   // ID del documento guardado (si aplica)
  itemsExtraidos    Int?
  impuestosExtraidos Int?
  reglasAplicadas   Int       @default(0)

  // Performance
  duracionMs        Int?
  duracionIAMs      Int?      // Tiempo específico de IA

  // Error
  errorTipo         String?   @db.VarChar(100)
  errorMensaje      String?   @db.Text
  errorStack        String?   @db.Text

  // Metadata
  ipAddress         String?   @db.VarChar(50)
  userAgent         String?   @db.Text
  metadata          Json?

  createdAt         DateTime  @default(now())

  tenants           tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([apiKeyId])
  @@index([estado])
  @@index([operacion])
  @@index([createdAt])
}

model webhooks {
  id             String         @id
  tenantId       String?        // Opcional: Para webhooks de tenant (sistema interno)
  oauthClientId  String?        // Opcional: Para webhooks de clientes OAuth (API pública)
  nombre         String
  url            String
  secret         String         // Secret para validación HMAC
  eventos        Json           @default("[]")
  activo         Boolean        @default(true)
  ultimoEnvio    DateTime?
  totalEnviado   Int            @default(0)
  totalExitoso   Int            @default(0)
  totalFallido   Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  tenants        tenants?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  oauth_clients  oauth_clients? @relation(fields: [oauthClientId], references: [id], onDelete: Cascade)
  webhook_logs   webhook_logs[]

  @@index([tenantId])
  @@index([oauthClientId])
  @@index([activo])
}

model webhook_logs {
  id            String    @id
  webhookId     String
  evento        String
  payload       Json
  statusCode    Int?
  respuesta     String?
  error         String?
  intentos      Int       @default(1)
  exitoso       Boolean   @default(false)
  enviadoEn     DateTime  @default(now())
  webhooks      webhooks  @relation(fields: [webhookId], references: [id])

  @@index([webhookId])
  @@index([evento])
  @@index([exitoso])
  @@index([enviadoEn])
}

model sync_configurations {
  id                  String      @id
  tenantId            String      @unique
  sqlServerHost       String
  sqlServerPort       Int         @default(1433)
  sqlServerDatabase   String
  sqlServerUser       String
  sqlServerPassword   String
  configuracionTablas Json
  version             Int         @default(1)
  ultimaModificacion  DateTime
  activo              Boolean     @default(true)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime
  tenants             tenants     @relation(fields: [tenantId], references: [id])
  sync_logs           sync_logs[]

  @@index([activo])
  @@index([tenantId])
}

model sync_logs {
  id                  String               @id
  tenantId            String
  configId            String?
  direccion           String
  tabla               String
  fase                String?
  ejecutadoEn         String?
  estado              String
  registrosAfectados  Int?
  mensaje             String?
  errorDetalle        String?
  duracionMs          Int?
  metadatos           Json?
  fechaInicio         DateTime
  fechaFin            DateTime?
  createdAt           DateTime             @default(now())
  sync_configurations sync_configurations? @relation(fields: [configId], references: [id])
  tenants             tenants              @relation(fields: [tenantId], references: [id])

  @@index([configId])
  @@index([estado])
  @@index([tabla])
  @@index([tenantId, createdAt])
}

// Clientes de sync-client-folder que se conectan para obtener configuración
model sync_clients {
  id                  String    @id
  tenantId            String
  nombre              String                // Nombre descriptivo del cliente
  hostname            String?               // Hostname de la máquina
  plataforma          String?               // win32, linux, darwin
  version             String?               // Versión del cliente instalado

  // Configuración operativa (lo que el cliente descarga)
  config              Json?                 // folder, email, output settings

  // Estado del cliente
  estado              String    @default("offline")  // online, offline, error
  ultimoHeartbeat     DateTime?
  ultimaIp            String?

  // Métricas
  documentosProcesados Int      @default(0)
  erroresCount        Int       @default(0)
  ultimoError         String?
  ultimoDocumento     DateTime?

  // Metadata
  activo              Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  createdBy           String?

  tenants             tenants   @relation(fields: [tenantId], references: [id])
  sync_client_logs    sync_client_logs[]

  @@unique([tenantId, nombre])
  @@index([activo])
  @@index([estado])
  @@index([tenantId])
}

// Logs de actividad de los clientes sync-client-folder
model sync_client_logs {
  id          String       @id
  clientId    String
  nivel       String       // info, warn, error
  mensaje     String
  metadata    Json?
  createdAt   DateTime     @default(now())

  sync_clients sync_clients @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, createdAt])
  @@index([nivel])
}

model tenants {
  id                        String                      @id
  slug                      String                      @unique
  nombre                    String
  cuit                      String                      @unique
  razonSocial               String?
  direccion                 String?
  telefono                  String?
  email                     String?
  planId                    String?
  activo                    Boolean                     @default(true)
  esDefault                 Boolean                     @default(false)
  fechaCreacion             DateTime                    @default(now())
  fechaVencimiento          DateTime?
  configuracion             Json                        @default("{}")
  limites                   Json                        @default("{}")
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  ai_prompts                ai_prompts[]
  ai_provider_configs       ai_provider_configs[]
  api_connector_configs     api_connector_configs[]
  api_export_logs           api_export_logs[]
  api_pull_logs             api_pull_logs[]
  api_sync_staging          api_sync_staging[]
  atributos                 atributos[]
  document_detection_config document_detection_config[]
  documento_distribuciones  documento_distribuciones[]
  documento_impuestos       documento_impuestos[]
  documento_lineas          documento_lineas[]
  documentos_procesados     documentos_procesados[]
  menu_items                menu_items[]
  parametros_maestros       parametros_maestros[]
  parametros_relaciones     parametros_relaciones[]
  patrones_aprendidos       patrones_aprendidos[]
  reglas_negocio            reglas_negocio[]
  sugerencias_ia            sugerencias_ia[]
  sync_api_keys             sync_api_keys[]
  sync_clients              sync_clients[]
  sync_configurations       sync_configurations?
  sync_logs                 sync_logs[]
  tenant_reglas_globales    tenant_reglas_globales[]
  webhooks                  webhooks[]
  oauth_clients             oauth_clients[]
  oauth_api_logs            oauth_api_logs[]
  parse_api_logs            parse_api_logs[]
  planes                    planes?                     @relation(fields: [planId], references: [id])
  users                     users[]

  @@index([activo])
  @@index([cuit])
  @@index([planId])
  @@index([slug])
}

model user_atributos {
  id               String           @id
  userId           String
  valorAtributoId  String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  users            users            @relation(fields: [userId], references: [id], onDelete: Cascade)
  valores_atributo valores_atributo @relation(fields: [valorAtributoId], references: [id], onDelete: Cascade)

  @@unique([userId, valorAtributoId])
  @@index([userId])
  @@index([valorAtributoId])
}

model users {
  id                        String                  @id
  email                     String                  @unique
  password                  String?
  nombre                    String
  apellido                  String
  activo                    Boolean                 @default(true)
  profileId                 String?
  tenantId                  String?
  superuser                 Boolean                 @default(false)
  emailVerified             Boolean                 @default(false)
  verificationToken         String?
  verificationExpires       DateTime?
  recibeNotificacionesEmail Boolean                 @default(false)
  googleId                  String?                 @unique
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime
  documentos_procesados     documentos_procesados[]
  sugerencias_ia            sugerencias_ia[]
  user_atributos            user_atributos[]
  profiles                  profiles?               @relation(fields: [profileId], references: [id])
  tenants                   tenants?                @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model valores_atributo {
  id             String           @id
  codigo         String
  descripcion    String
  atributoId     String
  activo         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user_atributos user_atributos[]
  atributos      atributos        @relation(fields: [atributoId], references: [id], onDelete: Cascade)

  @@unique([atributoId, codigo])
  @@index([activo])
  @@index([atributoId])
}

model documento_distribuciones {
  id                    String                 @id @default(cuid())
  documentoLineaId      String?
  documentoImpuestoId   String?
  tipoDimension         String                 @db.VarChar(50)
  tipoDimensionNombre   String?                @db.VarChar(200)
  importeDimension      Decimal                @db.Decimal(18, 2)
  orden                 Int                    @default(1)
  activo                Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  tenantId              String
  documentoId           String?
  documentos_procesados documentos_procesados? @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  documento_impuestos   documento_impuestos?   @relation(fields: [documentoImpuestoId], references: [id], onDelete: Cascade)
  documento_lineas      documento_lineas?      @relation(fields: [documentoLineaId], references: [id], onDelete: Cascade)
  tenants               tenants                @relation(fields: [tenantId], references: [id])
  documento_subcuentas  documento_subcuentas[]

  @@index([documentoId])
  @@index([documentoLineaId])
  @@index([documentoImpuestoId])
  @@index([tipoDimension])
  @@index([tenantId])
}

model documento_subcuentas {
  id                       String                   @id @default(cuid())
  distribucionId           String
  codigoSubcuenta          String                   @db.VarChar(20)
  subcuentaNombre          String?                  @db.VarChar(200)
  cuentaContable           String?                  @db.VarChar(20)
  porcentaje               Decimal                  @db.Decimal(5, 2)
  importe                  Decimal                  @db.Decimal(18, 2)
  orden                    Int                      @default(1)
  activo                   Boolean                  @default(true)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  documento_distribuciones documento_distribuciones @relation(fields: [distribucionId], references: [id], onDelete: Cascade)

  @@index([distribucionId])
  @@index([codigoSubcuenta])
  @@index([cuentaContable])
}

model tenant_reglas_globales {
  id                    String         @id @default(uuid())
  tenantId              String
  reglaGlobalId         String
  activa                Boolean        @default(true)
  prioridadOverride     Int?
  configuracionOverride Json?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  createdBy             String?
  updatedBy             String?
  reglas_negocio        reglas_negocio @relation(fields: [reglaGlobalId], references: [id], onDelete: Cascade)
  tenants               tenants        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, reglaGlobalId])
  @@index([tenantId])
  @@index([reglaGlobalId])
  @@index([activa])
}

model patrones_aprendidos {
  id              String   @id @default(uuid())
  tenantId        String
  tipo_patron     String   @db.VarChar(50)
  hash_pattern    String   @db.VarChar(64)
  input_pattern   Json
  output_value    String
  output_campo    String   @db.VarChar(100)
  confianza       Float    @default(1.0)
  num_ocurrencias Int      @default(1)
  ultima_fecha    DateTime @default(now())
  origen          String   @default("ai") @db.VarChar(20)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tenants         tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, tipo_patron, hash_pattern])
  @@index([tenantId])
  @@index([tipo_patron])
  @@index([hash_pattern])
  @@index([confianza])
  @@index([num_ocurrencias])
}

model document_detection_config {
  id          String   @id @default(uuid())
  tenantId    String?
  nombre      String   @db.VarChar(100)
  descripcion String?  @db.VarChar(500)
  activo      Boolean  @default(true)
  config      Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  tenants     tenants? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([activo])
}

// ============================================
// SISTEMA DE CONECTOR API BIDIRECCIONAL
// ============================================

model api_connector_configs {
  id                String   @id @default(uuid())
  tenantId          String
  nombre            String   @db.VarChar(100)
  descripcion       String?  @db.Text
  activo            Boolean  @default(true)

  // Dirección del conector: pull, push, bidirectional
  direction         String   @db.VarChar(20)

  // Configuración de conexión
  baseUrl           String   @db.VarChar(500)
  authType          String   @db.VarChar(50)
  authConfig        Json

  // Recursos (endpoints)
  pullResources     Json?
  pushResources     Json?

  // Mapeo de campos
  pullFieldMapping  Json?
  pushFieldMapping  Json?

  // Validación
  requireValidation Boolean  @default(false)
  validationRules   Json?

  // Programación
  pullSchedule      Json?
  pushSchedule      Json?

  // Callbacks
  callbackConfig    Json?

  // Metadata
  lastPullSync      DateTime?
  lastPullStatus    String?  @db.VarChar(50)
  lastPushSync      DateTime?
  lastPushStatus    String?  @db.VarChar(50)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenants           tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relaciones
  sync_staging      api_sync_staging[]
  export_logs       api_export_logs[]
  pull_logs         api_pull_logs[]

  @@index([tenantId])
  @@index([activo])
  @@index([direction])
}

model api_sync_staging {
  id                String   @id @default(uuid())
  configId          String
  resourceId        String   @db.VarChar(100)
  tenantId          String

  // Datos
  rawData           Json
  transformedData   Json

  // Validación
  validationStatus  String   @db.VarChar(50) // pending, approved, rejected
  validationErrors  Json?
  validatedBy       String?
  validatedAt       DateTime?

  // Metadata
  syncBatchId       String?
  createdAt         DateTime @default(now())

  config            api_connector_configs @relation(fields: [configId], references: [id], onDelete: Cascade)
  tenants           tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([tenantId])
  @@index([validationStatus])
  @@index([syncBatchId])
}

model api_pull_logs {
  id                String   @id @default(uuid())
  configId          String
  tenantId          String
  resourceId        String?  @db.VarChar(100)

  // Resultado
  status            String   @db.VarChar(50) // success, partial, failed
  recordsFound      Int      @default(0)
  recordsImported   Int      @default(0)
  recordsFailed     Int      @default(0)

  // Respuesta
  apiResponse       Json?

  // Metadata
  executedAt        DateTime @default(now())
  durationMs        Int?
  errorDetails      Json?

  config            api_connector_configs @relation(fields: [configId], references: [id], onDelete: Cascade)
  tenants           tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([tenantId])
  @@index([status])
  @@index([executedAt])
}

model api_export_logs {
  id                String   @id @default(uuid())
  configId          String
  tenantId          String

  // Documentos exportados
  documentIds       String[]
  totalDocuments    Int

  // Resultado
  status            String   @db.VarChar(50) // success, partial, failed
  successfulCount   Int      @default(0)
  failedCount       Int      @default(0)

  // Respuesta de API externa
  externalResponse  Json?
  externalIds       String[]

  // Metadata
  exportedBy        String?
  exportedAt        DateTime @default(now())
  durationMs        Int?
  errorDetails      Json?

  config            api_connector_configs @relation(fields: [configId], references: [id], onDelete: Cascade)
  tenants           tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([tenantId])
  @@index([status])
  @@index([exportedAt])
}

// ============================================
// OAUTH 2.0 & API CLIENTS
// ============================================

model oauth_clients {
  id                  String    @id @default(uuid())
  tenantId            String
  
  // Identificación
  clientId            String    @unique @db.VarChar(255)
  clientSecret        String    @db.VarChar(255) // Hasheado con bcrypt
  nombre              String    @db.VarChar(255)
  descripcion         String?   @db.Text
  
  // Configuración OAuth
  grantTypes          String[]  @default(["client_credentials"]) // client_credentials, authorization_code, refresh_token
  redirectUris        String[]  @default([])
  allowedScopes       String[]  @default(["read:documents", "write:documents"])
  
  // Rate limiting (heredado del plan del tenant o custom)
  customRateLimit     Boolean   @default(false)
  requestsPerMinute   Int?
  requestsPerHour     Int?
  requestsPerDay      Int?
  
  // Metadata
  activo              Boolean   @default(true)
  ultimoUso           DateTime?
  totalRequests       Int       @default(0)
  createdBy           String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  tenants             tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tokens              oauth_tokens[]
  api_logs            oauth_api_logs[]
  webhooks            webhooks[]

  @@index([tenantId])
  @@index([clientId])
  @@index([activo])
}

model oauth_tokens {
  id                  String    @id @default(uuid())
  clientId            String
  
  // Tokens
  accessToken         String    @unique @db.VarChar(500)
  refreshToken        String?   @unique @db.VarChar(500)
  tokenType           String    @default("Bearer") @db.VarChar(50)
  
  // Scopes y expiración
  scopes              String[]  @default([])
  expiresAt           DateTime
  refreshExpiresAt    DateTime?
  
  // Metadata
  createdAt           DateTime  @default(now())
  lastUsedAt          DateTime?
  revoked             Boolean   @default(false)
  revokedAt           DateTime?
  
  client              oauth_clients @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId])
  @@index([accessToken])
  @@index([refreshToken])
  @@index([expiresAt])
  @@index([revoked])
}

model oauth_api_logs {
  id                  String    @id @default(uuid())
  clientId            String
  tenantId            String
  
  // Request
  method              String    @db.VarChar(10)
  endpoint            String    @db.VarChar(500)
  ipAddress           String?   @db.VarChar(50)
  userAgent           String?   @db.Text
  
  // Response
  statusCode          Int
  responseTime        Int       // en milliseconds
  
  // Rate limiting
  rateLimitHit        Boolean   @default(false)
  
  // Metadata
  timestamp           DateTime  @default(now())
  errorMessage        String?   @db.Text
  
  client              oauth_clients @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenants             tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([clientId])
  @@index([tenantId])
  @@index([timestamp])
  @@index([endpoint])
}
