# Sesi√≥n de Desarrollo - 13 de Enero 2025

## üéØ Objetivos Cumplidos

1. ‚úÖ Implementar gesti√≥n de prompts GLOBAL para superadmins
2. ‚úÖ Solucionar crash del backend al procesar documentos con errores
3. ‚úÖ Mejorar mensajes de error para el usuario
4. ‚úÖ Agregar campo `errorMessage` a la base de datos
5. ‚úÖ Actualizar frontend para mostrar errores espec√≠ficos

---

## üìä Cambios Realizados

### **1. Sistema de Prompts GLOBAL (Superadmins)**

#### Objetivo
Permitir que los superadmins gestionen prompts globales que sirvan como fallback/template para todos los tenants.

#### Backend - `backend/src/routes/prompts.js`

**GET /api/prompts** (l√≠neas 13-56)
```javascript
// Superadmins ven prompts de su tenant + prompts GLOBAL
if (req.isSuperuser) {
  const globalFilters = { ...filters };
  delete globalFilters.tenantId;
  globalFilters.tenantId = null; // Buscar solo GLOBAL

  const globalPrompts = await promptManager.listPrompts(globalFilters);
  prompts = [...prompts, ...globalPrompts];
}
```

**POST /api/prompts** (l√≠neas 285-348)
```javascript
// Acepta campo isGlobal: true para crear prompts GLOBAL
if (isGlobal === true) {
  if (!req.isSuperuser) {
    return res.status(403).json({ error: 'Solo superadmins pueden crear prompts GLOBAL' });
  }
  tenantId = null; // Prompt GLOBAL (sin tenant)
}
```

**PUT /api/prompts/:id** (l√≠neas 356-434)
```javascript
// Verificar permisos para editar prompts GLOBAL
const isGlobal = promptExistente.tenantId === null;
const canEdit = isOwnTenant || (req.isSuperuser && isGlobal);
```

**DELETE /api/prompts/:id** (l√≠neas 442-494)
```javascript
// Verificar permisos para eliminar prompts GLOBAL
const canDelete = isOwnTenant || (req.isSuperuser && isGlobal);
```

#### Frontend - `frontend/src/app/(protected)/prompts-ia/page.tsx`

**Cambios realizados:**
1. Importado `useAuth()` y hook `Globe` de lucide-react
2. Agregado campo `isGlobal: boolean` al formData
3. Checkbox "Prompt Global" visible solo para superadmins (l√≠neas 542-556)
4. Badge azul üåê "GLOBAL" en la tabla para prompts sin tenant (l√≠neas 344-349)
5. Nota informativa cuando se marca un prompt como GLOBAL (l√≠neas 558-564)

**C√≥digo del Badge:**
```tsx
{prompt.tenantId === null && (
  <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
    <Globe className="h-3 w-3" />
    GLOBAL
  </span>
)}
```

#### Prompts GLOBAL Existentes
Actualmente hay **6 prompts GLOBAL** en el sistema:
1. `CLASIFICADOR_DOCUMENTO`
2. `EXTRACCION_DESPACHO_ADUANA`
3. `EXTRACCION_FACTURA_A`
4. `EXTRACCION_FACTURA_B`
5. `EXTRACCION_FACTURA_C`
6. `EXTRACCION_UNIVERSAL` (fallback para tipo "OTRO")

---

### **2. Soluci√≥n al Crash del Backend**

#### Problema Original
```
Error: No se pudieron extraer datos suficientes del documento...
    at processDocumentAsync (documentos.js:2642:13)

Node.js v22.13.0
[nodemon] app crashed - waiting for file changes before starting...
```

**Causa:** La funci√≥n `processDocumentAsync()` se llama sin `await` (fire-and-forget) y lanzaba errores no capturados.

#### Soluci√≥n Implementada

**Base de Datos - Nuevo campo:**
```prisma
model documentos_procesados {
  // ... campos existentes
  errorMessage  String?  // ‚Üê NUEVO
}
```

**Backend - `backend/src/routes/documentos.js`**

**Cambio 1: Guardar errores en lugar de eliminar documentos**

L√≠neas 2638-2651 (Validaci√≥n de datos m√≠nimos):
```javascript
if (!criterioExitoso) {
  // ANTES: await eliminarDocumentoCompletamente(documentoId);

  // AHORA: Marcar como error
  await prisma.documentos_procesados.update({
    where: { id: documentoId },
    data: {
      estadoProcesamiento: 'error',
      errorMessage: 'No se pudieron extraer datos suficientes del documento. Verifica que el archivo sea legible y contenga informaci√≥n v√°lida de un comprobante fiscal (fecha, importe, CUIT).'
    }
  });

  throw new Error('...');
}
```

L√≠neas 2668-2686 (Validaci√≥n de duplicados):
```javascript
if (documentoContenidoDuplicado) {
  // ANTES: await eliminarDocumentoCompletamente(documentoId);

  // AHORA: Marcar como error
  const errorMsg = `Comprobante duplicado: Ya existe un comprobante con CUIT ${datosExtraidos.cuit}, tipo ${datosExtraidos.tipoComprobante} y n√∫mero ${datosExtraidos.numeroComprobante}.`;
  await prisma.documentos_procesados.update({
    where: { id: documentoId },
    data: {
      estadoProcesamiento: 'error',
      errorMessage: errorMsg
    }
  });

  throw new Error(errorMsg);
}
```

**Cambio 2: Catch global sin re-lanzar error**

L√≠neas 2896-2929:
```javascript
} catch (error) {
  console.error('‚ùå Error procesando documento:', error.message);
  console.error('‚ö†Ô∏è  Marcando documento como error para que el usuario vea el mensaje');

  try {
    // Actualizar documento con estado de error y mensaje
    await prisma.documentos_procesados.update({
      where: { id: documentoId },
      data: {
        estadoProcesamiento: 'error',
        errorMessage: error.message || 'Error desconocido al procesar el documento'
      }
    });

    console.log(`‚úÖ Documento marcado como error con mensaje: ${error.message}`);
  } catch (updateError) {
    // Si falla la actualizaci√≥n, intentar eliminar para evitar documentos zombie
    try {
      await eliminarDocumentoCompletamente(documentoId);
      console.log('üóëÔ∏è Documento eliminado tras fallo en actualizaci√≥n de error');
    } catch (deleteError) {
      console.error('‚ùå Error eliminando documento tras falla:', deleteError);
    }
  }

  // NO RE-LANZAR el error - esta funci√≥n se llama de forma as√≠ncrona (fire-and-forget)
  console.error('‚ö†Ô∏è  Procesamiento fallido - Error guardado en BD para el usuario');
}
```

**Cambio 3: Prisma Client regenerado**
```bash
cd backend
npx prisma generate
```

#### Frontend - `frontend/src/components/shared/DocumentUploadModal.tsx`

**Cambio 1: Agregado campo errorMessage a la interfaz**
```typescript
interface DocumentoProcessed {
  // ... campos existentes
  errorMessage?: string;  // ‚Üê NUEVO
}
```

**Cambio 2: Mostrar errorMessage cuando el estado es 'error'**

L√≠neas 321-333:
```typescript
} else if (documento.estadoProcesamiento === 'error') {
  setFiles(prev => prev.map((f, idx) =>
    idx === fileIndex ? {
      ...f,
      status: 'error',
      error: documento.errorMessage || documento.observaciones || 'Error al procesar el documento',
      currentStep: 'Error',
      progress: 0
    } : f
  ));
  return null;
}
```

#### Resultado Final

**Antes:**
```
‚ùå Backend crashea con unhandled promise rejection
‚ùå Usuario ve: "Request failed with status code 404"
‚ùå Usuario piensa: "La app se rompi√≥"
```

**Ahora:**
```
‚úÖ Backend NO crashea
‚úÖ Documento queda marcado como 'error' con mensaje descriptivo
‚úÖ Usuario ve: "No se pudieron extraer datos suficientes del documento. Verifica que el archivo sea legible y contenga informaci√≥n v√°lida de un comprobante fiscal (fecha, importe, CUIT)."
‚úÖ Usuario entiende: "Mi documento tiene un problema, no la aplicaci√≥n"
‚úÖ Usuario puede eliminar el documento manualmente desde la UI
```

---

## üóÑÔ∏è Cambios en Base de Datos

### Schema Prisma - `backend/prisma/schema.prisma`

**L√≠nea 180:** Agregado campo `errorMessage`
```prisma
model documentos_procesados {
  id                        String                @id
  nombreArchivo             String
  tipoArchivo               String
  rutaArchivo               String
  fechaProcesamiento        DateTime              @default(now())
  estadoProcesamiento       String                @default("procesando")
  datosExtraidos            Json?
  // ... otros campos ...
  errorMessage              String?               // ‚Üê NUEVO
  documento_impuestos       documento_impuestos[]
  documento_lineas          documento_lineas[]
  tenants                   tenants               @relation(fields: [tenantId], references: [id])
  users                     users                 @relation(fields: [usuarioId], references: [id])

  @@index([tenantId])
  @@index([tipo])
  @@index([exportado])
  @@index([reglasAplicadas])
}
```

**Comando aplicado:**
```bash
cd backend
npx prisma db push
npx prisma generate
```

---

## üìù Otros Cambios Menores

### Pregunta sobre Prompts y Clasificadores

**Pregunta:** "Cuando detecta un tipoComprobante = 'OTRO' que prompt usa para extraer los datos?"

**Respuesta:** El sistema usa `EXTRACCION_UNIVERSAL` como fallback.

**C√≥digo en `documentExtractionOrchestrator.js:401`:**
```javascript
getPromptKeyForDocumentType(tipoDocumento) {
  const mapping = {
    'FACTURA_A': 'EXTRACCION_FACTURA_A',
    'FACTURA_B': 'EXTRACCION_FACTURA_B',
    'FACTURA_C': 'EXTRACCION_FACTURA_C',
    'DESPACHO_ADUANA': 'EXTRACCION_DESPACHO_ADUANA',
    'COMPROBANTE_IMPORTACION': 'EXTRACCION_COMPROBANTE_IMPORTACION',
    'NOTA_CREDITO': 'EXTRACCION_FACTURA_A',
    'TICKET': 'EXTRACCION_FACTURA_C'
  };

  return mapping[tipoDocumento] || 'EXTRACCION_UNIVERSAL'; // ‚Üê Fallback
}
```

---

## üîç Testing y Validaci√≥n

### Frontend
```bash
cd frontend
npm run build
```
**Resultado:** ‚úÖ Build exitoso - 25 p√°ginas generadas sin errores TypeScript

### Backend
```bash
cd backend
node -c src/routes/documentos.js
```
**Resultado:** ‚úÖ Sin errores de sintaxis

### Base de Datos
```bash
cd backend
npx prisma db push
npx prisma generate
```
**Resultado:** ‚úÖ Schema sincronizado - Prisma Client regenerado

---

## üìÇ Archivos Modificados

### Backend
1. `backend/prisma/schema.prisma` - Agregado campo `errorMessage`
2. `backend/src/routes/prompts.js` - Implementada gesti√≥n de prompts GLOBAL
3. `backend/src/routes/documentos.js` - Mejorado manejo de errores sin crash

### Frontend
1. `frontend/src/app/(protected)/prompts-ia/page.tsx` - UI para prompts GLOBAL
2. `frontend/src/components/shared/DocumentUploadModal.tsx` - Mostrar errorMessage

### Documentaci√≥n
1. `SESION-2025-01-13.md` - Este archivo de documentaci√≥n

---

## üöÄ Instrucciones para Pr√≥xima Sesi√≥n

### Para Reiniciar el Servidor

**Backend:**
```bash
cd backend
npm run dev
# O con PM2:
pm2 restart parse-backend
```

**Frontend:**
```bash
cd frontend
npm run dev
# O con PM2:
pm2 restart parse-frontend
```

### Verificar que Todo Funciona

1. **Prompts GLOBAL:**
   - Login como superadmin
   - Ir a "Prompts IA"
   - Verificar que se ven los 6 prompts GLOBAL con badge azul üåê
   - Intentar crear un nuevo prompt marcando "Prompt Global"

2. **Manejo de Errores:**
   - Subir un documento inv√°lido (imagen sin texto, PDF corrupto)
   - Verificar que:
     - El backend NO crashea
     - El documento queda con estado `error`
     - El usuario ve un mensaje claro y espec√≠fico
     - El documento puede eliminarse manualmente

3. **Clasificador y Extracci√≥n:**
   - Subir un documento v√°lido
   - Verificar que se usa el prompt especializado seg√∫n el tipo
   - Si no se clasifica, verificar que usa `EXTRACCION_UNIVERSAL` como fallback

---

## üêõ Problemas Conocidos y Soluciones

### Problema: Prisma Client desactualizado
**S√≠ntoma:** Error `Unknown argument 'errorMessage'`
**Soluci√≥n:**
```bash
cd backend
npx prisma generate
```

### Problema: Backend crashea al procesar documento
**S√≠ntoma:** `[nodemon] app crashed - waiting for file changes`
**Soluci√≥n:** Ya solucionado en esta sesi√≥n - documentos ahora se marcan como error

### Problema: Usuario ve "Request failed with status code 404"
**S√≠ntoma:** Mensaje gen√©rico en lugar de error espec√≠fico
**Soluci√≥n:** Ya solucionado - ahora se muestra `errorMessage` del backend

---

## üìä Estado del Sistema

### Prompts Configurados
- **5 Clasificadores:** GLOBAL + 4 tenant-specific (Keysoft, Industrias Qu√≠micas, Grupo Loraschi Batalla, Empresa Demo)
- **6 Prompts GLOBAL:** CLASIFICADOR_DOCUMENTO, EXTRACCION_FACTURA_A/B/C, EXTRACCION_DESPACHO_ADUANA, EXTRACCION_UNIVERSAL
- **M√∫ltiples prompts tenant-specific** para cada cliente

### Base de Datos
- ‚úÖ Campo `errorMessage` agregado
- ‚úÖ √çndices actualizados
- ‚úÖ Relaciones intactas

### APIs
- ‚úÖ Todos los endpoints funcionando
- ‚úÖ Validaciones de permisos implementadas
- ‚úÖ Manejo de errores robusto

---

## üí° Mejoras Futuras Sugeridas

1. **UI para gesti√≥n de documentos con error:**
   - Bot√≥n "Reprocesar" para reintentar extracci√≥n
   - Vista detallada del error con stack trace (solo para admins)
   - Filtro en lista de documentos para ver solo errores

2. **Notificaciones en tiempo real:**
   - WebSocket o SSE para notificar al usuario cuando termina el procesamiento
   - Toast notification con el resultado (√©xito/error)

3. **M√©tricas y monitoreo:**
   - Dashboard con tasa de √©xito/error de extracci√≥n
   - Prompts m√°s usados
   - Tipos de error m√°s comunes

4. **Mejora de prompts:**
   - Entrenamiento con documentos reales
   - A/B testing de prompts
   - Versionado de prompts con rollback

---

## üìû Contacto y Soporte

Para dudas sobre esta sesi√≥n:
- Revisar este documento: `SESION-2025-01-13.md`
- Verificar logs del backend para mensajes espec√≠ficos
- Consultar documentaci√≥n de Prisma para cambios de schema

---

**Fin de la Documentaci√≥n de Sesi√≥n**
