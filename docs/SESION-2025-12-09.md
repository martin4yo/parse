# Sesión de Trabajo - 9 de Diciembre 2025

## Resumen Ejecutivo

Esta sesión se enfocó en corregir múltiples problemas relacionados con el **motor de reglas de negocio** y la integración con el asistente de IA **Axio**. Los principales logros fueron:

1. Corrección de la regla `REGLA_CUENTA_CONTABLE_ITEMS` para extraer correctamente `cuentaContable` y `subcuenta`
2. Corrección de la regla `COMPLETAR_PROVEEDOR_POR_CUIT` que no funcionaba desde el frontend
3. Mejoras al motor de reglas con nuevas transformaciones de campo
4. Actualización del prompt de Axio para evitar errores futuros

---

## Problemas Resueltos

### 1. REGLA_CUENTA_CONTABLE_ITEMS no extraía cuentaContable

**Problema:** La regla no encontraba el valor en `parametros_json`.

**Causas identificadas:**
- `campoResultado` era `parametro_json` (singular) en lugar de `parametros_json` (plural)
- Faltaba `filtroAdicional` para `tipo_campo`
- `campoJSON` necesitaba soportar múltiples nombres (`cuentacontable` y `cuenta_contable`)
- Faltaba `tenantId` en el lookup
- Nombres de campos obsoletos: `lineaId`/`impuestoId` debían ser `documentoLineaId`/`documentoImpuestoId`

**Solución:** Se corrigieron todos los campos y se agregó soporte para múltiples nombres de campo JSON separados por coma.

### 2. Extracción de subcuenta para CREATE_DISTRIBUTION

**Problema:** El usuario quería extraer `subcuenta` del mismo JSON y usarlo en CREATE_DISTRIBUTION.

**Solución:**
- Se agregó método `resolveTemplateField()` al motor de reglas
- Se implementó interpolación de templates en subcuentas (`{campo}` syntax)
- Se corrigió el campo `tenantId` que no existe en `documento_subcuentas`

### 3. Error de validación en ReglaModal (frontend)

**Problema:** Error `.trim() of undefined` al guardar reglas con CREATE_DISTRIBUTION.

**Causa:** CREATE_DISTRIBUTION no tiene campo `campo` obligatorio.

**Solución:** Se excluyó CREATE_DISTRIBUTION de la validación de campo obligatorio en `ReglaModal.tsx`.

### 4. "Error en suma" en distribuciones válidas

**Problema:** Distribuciones al 100% mostraban "Error en suma".

**Causa:** El hook `useComprobanteEdit.ts` buscaba un campo `porcentajeDistribucion` que no existe.

**Solución:** Se cambió para sumar los porcentajes de las subcuentas en lugar de buscar el campo inexistente.

### 5. Campo "Orden Compra" no editable

**Problema:** No se podía editar el número de orden de compra en el modal.

**Solución:** Se agregó `onClick` handler con tipo `texto_libre` en `ComprobanteEditModal.tsx`.

### 6. Axio generaba reglas con operación incorrecta (LOOKUP vs LOOKUP_JSON)

**Problema:** Axio creó regla `ASIGNAR_PROVEEDOR_POR_CUIT` con LOOKUP en lugar de LOOKUP_JSON.

**Solución:** Se actualizó el system prompt de Axio en `aiAssistantService.js` explicando cuándo usar cada operación.

### 7. codigoProveedor no persistía desde frontend

**Problema:** El código del proveedor se mostraba pero no se guardaba en la BD.

**Causa:** El endpoint `PUT /datos-extraidos` no incluía `codigoProveedor` en el destructuring ni en el procesamiento.

**Solución:** Se agregó `codigoProveedor` al endpoint en `documentos.js`.

### 8. Regla funciona en terminal pero no desde botón del frontend

**Problema:** `COMPLETAR_PROVEEDOR_POR_CUIT` funcionaba al ejecutarla manualmente pero no desde el frontend.

**Causas identificadas:**
1. `applyRulesToDocument` solo cargaba reglas tipo `TRANSFORMACION_DOCUMENTO`, pero la regla era tipo `TRANSFORMACION` con `aplicaA: DOCUMENTO`
2. La regla usaba campo `cuitProveedor` que **NO EXISTE** en la tabla - el campo correcto es `cuitExtraido`
3. El CUIT venía con guiones (`30-70717404-4`) y necesitaba normalizarse

**Solución:**
1. Se modificó `applyRulesToDocument` para cargar también reglas `TRANSFORMACION` cuando no hay `TRANSFORMACION_DOCUMENTO`
2. Se corrigió la regla para usar `cuitExtraido`
3. Se agregó transformación `NORMALIZE_CUIT` a la regla

---

## Código Modificado

### Backend

| Archivo | Cambios |
|---------|---------|
| `src/services/businessRulesEngine.js` | Agregado `resolveTemplateField()`, tenantId en lookups, nuevas transformaciones (NORMALIZE_CUIT, REMOVE_DASHES, REMOVE_SPECIAL_CHARS), corrección de nombres de campos, carga de reglas TRANSFORMACION en applyRulesToDocument |
| `src/services/aiAssistantService.js` | Actualizado system prompt con: campos del documento, transformaciones disponibles, aclaración cuitExtraido vs cuitProveedor |
| `src/routes/documentos.js` | Agregado codigoProveedor al endpoint PUT /datos-extraidos |

### Frontend

| Archivo | Cambios |
|---------|---------|
| `src/components/parametros/ReglaModal.tsx` | Excluido CREATE_DISTRIBUTION de validación de campo |
| `src/hooks/useComprobanteEdit.ts` | Corregida validación de distribuciones para sumar subcuentas |
| `src/components/comprobantes/ComprobanteEditModal.tsx` | Agregado onClick para editar ordenCompra |

### Base de Datos

| Tabla | Cambios |
|-------|---------|
| `reglas_negocio` | Actualizada configuración de COMPLETAR_PROVEEDOR_POR_CUIT |

---

## Nuevas Transformaciones de Campo

Se agregaron al motor de reglas (`businessRulesEngine.js`):

```javascript
case 'REMOVE_DASHES':
  return String(value).replace(/-/g, '');

case 'REMOVE_SPECIAL_CHARS':
  return String(value).replace(/[^a-zA-Z0-9]/g, '');

case 'NORMALIZE_CUIT':
  // Remueve guiones y espacios del CUIT argentino
  return String(value).replace(/[-\s]/g, '');
```

### Uso en Reglas

```json
{
  "transformacionesCampo": [
    { "campo": "cuitExtraido", "transformacion": "NORMALIZE_CUIT" }
  ],
  "condiciones": [...],
  "acciones": [...]
}
```

---

## Configuración Actual de la Regla COMPLETAR_PROVEEDOR_POR_CUIT

```json
{
  "aplicaA": ["DOCUMENTO"],
  "transformacionesCampo": [
    {
      "campo": "cuitExtraido",
      "transformacion": "NORMALIZE_CUIT"
    }
  ],
  "acciones": [{
    "campo": "codigoProveedor",
    "campoJSON": "cuit",
    "operacion": "LOOKUP_JSON",
    "tipoCampo": "proveedor",
    "valorConsulta": "{cuitExtraido}",
    "campoResultado": "codigo"
  }],
  "condiciones": [
    { "campo": "cuitExtraido", "operador": "IS_NOT_EMPTY" },
    { "campo": "codigoProveedor", "operador": "IS_EMPTY" }
  ],
  "stopOnMatch": false,
  "logicOperator": "AND"
}
```

---

## Información Importante para Axio

Se agregó al system prompt de Axio:

### Campos del Documento
- `cuitExtraido` - CUIT del proveedor (NOTA: es cuitExtraido, NO cuitProveedor)
- `codigoProveedor` - Código interno del proveedor
- `razonSocialExtraida`, `fechaExtraida`, `importeExtraido`, etc.

### Transformaciones Disponibles
- `NORMALIZE_CUIT` - Normaliza CUIT quitando guiones
- `REMOVE_DASHES`, `REMOVE_SPECIAL_CHARS`
- `TRIM_SPACES`, `UPPER_CASE`, `LOWER_CASE`
- `CUSTOM_FUNCTION` - Función JavaScript personalizada

---

## Estado Actual del Sistema

### ✅ Funcionando Correctamente
- Motor de reglas con todas las operaciones (LOOKUP, LOOKUP_JSON, AI_LOOKUP, CREATE_DISTRIBUTION, etc.)
- Transformaciones de campo incluyendo NORMALIZE_CUIT
- Regla COMPLETAR_PROVEEDOR_POR_CUIT funciona desde terminal y frontend
- Regla REGLA_CUENTA_CONTABLE_ITEMS extrae cuentaContable y subcuenta
- CREATE_DISTRIBUTION crea distribuciones con subcuentas
- Validación de distribuciones muestra estado correcto
- Campo ordenCompra es editable
- codigoProveedor persiste en BD
- Axio genera reglas con operaciones correctas

### ⚠️ Pendiente de Verificar
- Probar desde el frontend que la regla COMPLETAR_PROVEEDOR_POR_CUIT funcione correctamente con el botón "Aplicar Reglas"

---

## Próximos Pasos Sugeridos

1. **Testing Frontend**: Verificar que todas las correcciones funcionen desde la interfaz de usuario
2. **Documentación**: Actualizar CLAUDE.md con las nuevas transformaciones
3. **Axio**: Considerar agregar más ejemplos al prompt para reglas con transformaciones

---

## Conexión a Base de Datos

```
Host: 149.50.148.198
Usuario: postgres
Password: Q27G4B98
Puerto: 5432
Base de datos: rendiciones_parse
```

---

## Tenant de Pruebas

```
TenantId: 4b458e4f-f35d-47c4-a9d5-0960c1858939
Nombre: Timbo
```

---

## Scripts de Prueba Creados

| Script | Descripción |
|--------|-------------|
| `backend/scripts/test-regla-proveedor-documento.js` | Prueba la regla COMPLETAR_PROVEEDOR_POR_CUIT en contexto de documento |
| `backend/scripts/test-proveedor-rule.js` | Prueba básica de la regla de proveedor |
| `backend/scripts/test-proveedor-debug.js` | Debug de la regla y datos |
| `backend/scripts/test-cuit-fields.js` | Verifica campos CUIT en documentos |

---

## Lecciones Aprendidas

1. **Campos de BD**: Siempre verificar que los campos existen en el schema antes de usarlos en reglas
2. **Normalización de datos**: Los CUITs argentinos pueden venir con o sin guiones, siempre normalizar
3. **Tipos de reglas**: `TRANSFORMACION` con `aplicaA: DOCUMENTO` es diferente de `TRANSFORMACION_DOCUMENTO`
4. **Axio**: El prompt del asistente debe incluir información precisa sobre los campos disponibles
