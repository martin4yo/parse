# üìã Sistema de Men√∫ Din√°mico - Gu√≠a Completa

## ‚úÖ Implementaci√≥n Completada

Sistema completo de gesti√≥n de men√∫ del sidebar construido desde base de datos con interfaz de administraci√≥n.

---

## üì¶ Componentes del Sistema

### 1. **Base de Datos**

#### Tabla `menu_items`
```sql
CREATE TABLE "menu_items" (
    id TEXT PRIMARY KEY,
    parentId TEXT,                  -- NULL = nivel 1, ID = nivel 2
    title VARCHAR(100),             -- T√≠tulo visible
    icon VARCHAR(50),               -- Nombre del √≠cono de lucide-react
    url VARCHAR(255),               -- Ruta de navegaci√≥n (NULL si es contenedor)
    description VARCHAR(500),       -- Descripci√≥n del item
    orderIndex INTEGER DEFAULT 0,  -- Orden de visualizaci√≥n
    isActive BOOLEAN DEFAULT true, -- Activo/Inactivo
    requiresPermission VARCHAR(100), -- Permiso opcional
    superuserOnly BOOLEAN,         -- Solo visible para superusuarios
    tenantId TEXT,                 -- Multi-tenant (NULL = global)
    createdAt TIMESTAMP,
    updatedAt TIMESTAMP,
    createdBy TEXT,
    updatedBy TEXT
)
```

**Caracter√≠sticas:**
- ‚úÖ Jerarqu√≠a de 2 niveles (padre ‚Üí hijo)
- ‚úÖ √çconos configurables de lucide-react
- ‚úÖ URLs configurables por item
- ‚úÖ Soporte multi-tenant
- ‚úÖ Control de permisos y superusuarios
- ‚úÖ Ordenamiento personalizable

**Ubicaci√≥n:** `backend/prisma/schema.prisma` l√≠neas 1116-1146

---

### 2. **Backend - API**

#### Endpoints Disponibles

| M√©todo | Ruta | Descripci√≥n | Permisos |
|--------|------|-------------|----------|
| `GET` | `/api/menu` | Obtiene men√∫ jer√°rquico completo | Usuario autenticado |
| `GET` | `/api/menu/:id` | Obtiene un item espec√≠fico | Usuario autenticado |
| `POST` | `/api/menu` | Crea nuevo item | Superusuario |
| `PUT` | `/api/menu/:id` | Actualiza item existente | Superusuario |
| `DELETE` | `/api/menu/:id` | Elimina item (cascada) | Superusuario |
| `PATCH` | `/api/menu/:id/reorder` | Cambia orden del item | Superusuario |
| `GET` | `/api/menu/icons/available` | Lista de √≠conos disponibles | P√∫blico |

**Filtros Autom√°ticos:**
- Por tenant del usuario
- Por permisos de superusuario
- Solo items activos (`isActive = true`)

**Ubicaci√≥n:** `backend/src/routes/menu.js`

---

### 3. **Frontend - Hook useMenu**

Hook personalizado para consumir la API del men√∫:

```typescript
import { useMenu } from '@/hooks/useMenu';

function MyComponent() {
  const { menuItems, loading, error, refetch } = useMenu();

  // menuItems: MenuItem[] - Items del men√∫
  // loading: boolean - Estado de carga
  // error: Error | null - Error si ocurri√≥
  // refetch: () => Promise<void> - Recargar men√∫
}
```

**Interface MenuItem:**
```typescript
interface MenuItem {
  id: string;
  parentId: string | null;
  title: string;
  icon: string;
  url: string | null;
  description: string | null;
  orderIndex: number;
  isActive: boolean;
  requiresPermission: string | null;
  superuserOnly: boolean;
  tenantId: string | null;
  children?: MenuItem[];
}
```

**Ubicaci√≥n:** `packages/web/src/hooks/useMenu.ts`

---

### 4. **Frontend - Sidebar Din√°mico**

El componente `Sidebar.tsx` fue actualizado para consumir el men√∫ desde la API.

**Caracter√≠sticas:**
- ‚úÖ Carga din√°mica desde base de datos
- ‚úÖ Mapa de √≠conos de lucide-react
- ‚úÖ Estados de carga
- ‚úÖ Filtrado autom√°tico por permisos
- ‚úÖ Mantiene funcionalidad de colapsar/expandir
- ‚úÖ Navegaci√≥n con query params preservados

**Ubicaci√≥n:** `packages/web/src/components/layout/Sidebar.tsx`

**IconMap:** Resuelve din√°micamente componentes de √≠conos desde strings:
```typescript
const IconMap = {
  Home, FileText, CreditCard, Settings, // ... etc
};

const getIconComponent = (iconName: string) => {
  return IconMap[iconName] || FileText; // Fallback
};
```

---

### 5. **Panel de Administraci√≥n**

Interfaz completa para gestionar items del men√∫ en `/admin/menu` (solo superusuarios).

#### Componentes Creados:

**1. MenuAdminPage** - P√°gina principal
- **Ubicaci√≥n:** `packages/web/src/app/(protected)/admin/menu/page.tsx`
- Grid de 3 columnas (lista + preview)
- Bot√≥n "Nuevo Item"
- Modal de formulario

**2. MenuItemsList** - Listado jer√°rquico con drag & drop
- **Ubicaci√≥n:** `packages/web/src/components/admin/menu/MenuItemsList.tsx`
- Muestra items en √°rbol (padre ‚Üí hijos)
- **Drag & Drop funcional** usando @hello-pangea/dnd
- Reordenar items padre arrastrando verticalmente
- Reordenar items hijo dentro de su secci√≥n
- Feedback visual durante arrastre (highlight azul)
- Handle de arrastre (icono ‚ãÆ‚ãÆ)
- Botones Editar/Eliminar
- Badges de estado (Activo, Superuser, Inactivo)
- Confirmaci√≥n antes de eliminar
- Actualizaci√≥n autom√°tica del orderIndex

**3. MenuItemForm** - Formulario CRUD
- **Ubicaci√≥n:** `packages/web/src/components/admin/menu/MenuItemForm.tsx`
- Crear y editar items
- Validaciones de campos requeridos
- Selector de √≠cono (dropdown con todos los disponibles)
- Selector de item padre (para crear sub-items)
- Checkboxes para Activo/Superuser
- Modal responsive

**4. MenuPreview** - Vista previa del sidebar
- **Ubicaci√≥n:** `packages/web/src/components/admin/menu/MenuPreview.tsx`
- Simula c√≥mo se ver√° el sidebar
- √çconos con emojis
- Secciones expandibles
- Badges de Superuser
- Filtrado por items activos

---

## üöÄ Datos Iniciales

28 items migrados autom√°ticamente desde el sidebar hardcodeado:

**Nivel 1 (8 secciones):**
1. Dashboard
2. Comprobantes
3. Rendiciones
4. Autorizaci√≥n
5. Exportar
6. Tesorer√≠a
7. Configuraci√≥n
8. Sincronizaci√≥n

**Nivel 2 (20 sub-items):**
- Dashboard: Dashboard, Reportes
- Comprobantes: Efectivo, Tarjeta, Extracci√≥n de datos
- Rendiciones: Efectivo, Tarjeta
- Tesorer√≠a: Adelantos, Pagos, Devoluciones, Importar Resumen, Liquidaci√≥n, Estado de Cuenta
- Configuraci√≥n: Usuarios, Par√°metros, Prompts IA, Planes, Tarjetas, Tenants, **Gesti√≥n de Men√∫** (nuevo)
- Sincronizaci√≥n: Configuraciones, API Keys

**Script de seed:** `backend/src/seed/menu-items.js`

Para volver a ejecutar el seed:
```bash
cd backend
node src/seed/menu-items.js
```

---

## üìñ Uso del Sistema

### Para Usuarios Finales

El men√∫ se carga autom√°ticamente al iniciar sesi√≥n. No requiere acci√≥n adicional.

**Visibilidad:**
- Los usuarios normales ven todos los items EXCEPTO los marcados con `superuserOnly`
- Los superusuarios ven TODOS los items (incluyendo Tenants, Sincronizaci√≥n, Gesti√≥n de Men√∫)

### Para Administradores (Superusuarios)

1. **Acceder al panel de administraci√≥n:**
   - Navegar a `Configuraci√≥n ‚Üí Gesti√≥n de Men√∫`
   - O directamente a `/admin/menu`

2. **Crear nuevo item:**
   - Click en "Nuevo Item"
   - Completar formulario:
     - T√≠tulo (requerido)
     - √çcono (requerido)
     - URL (opcional, dejar vac√≠o si es contenedor)
     - Descripci√≥n (opcional)
     - Item Padre (opcional, para crear sub-item)
     - Orden (n√∫mero, menor = primero)
     - Activo (checkbox)
     - Solo Superusuarios (checkbox)
   - Click "Crear"

3. **Editar item existente:**
   - Click en bot√≥n "Editar" (√≠cono l√°piz)
   - Modificar campos
   - Click "Guardar"

4. **Eliminar item:**
   - Click en bot√≥n "Eliminar" (√≠cono papelera)
   - Confirmar eliminaci√≥n
   - **Nota:** Si tiene hijos, se eliminar√°n en cascada

5. **Reordenar items:**

   **M√©todo 1: Drag & Drop (Recomendado)**
   - Hacer clic y mantener presionado en el √≠cono de agarrar (‚ãÆ‚ãÆ)
   - Arrastrar el item a la nueva posici√≥n
   - Soltar
   - El orden se actualiza autom√°ticamente

   **M√©todo 2: Manual**
   - Editar el item
   - Cambiar el campo "Orden"
   - Guardar

6. **Activar/Desactivar:**
   - Editar el item
   - Desmarcar checkbox "Activo"
   - Guardar
   - El item desaparecer√° del sidebar pero se conservar√° en BD

---

## üé® √çconos Disponibles

35 √≠conos de lucide-react disponibles:

```
Home, Upload, CreditCard, Settings, LogOut, User, Users, FileText,
PieChart, Receipt, Shield, Send, Building2, BarChart3, FileCheck,
Banknote, CheckCircle, Folder, TrendingUp, Calculator, DollarSign,
Download, FileBarChart, ArrowUpCircle, ArrowDownCircle, RefreshCw,
Key, Sparkles, ScanText, Package
```

Para agregar m√°s √≠conos:
1. Importar desde `lucide-react` en `Sidebar.tsx`
2. Agregar al objeto `IconMap`
3. Agregar al array `AVAILABLE_ICONS` en `MenuItemForm.tsx`

---

## üîß Casos de Uso Comunes

### Crear secci√≥n de nivel 1 sin hijos

```
T√≠tulo: Reportes
√çcono: BarChart3
URL: /reportes
Item Padre: Ninguno
Orden: 9
```

### Crear secci√≥n de nivel 1 CON hijos (contenedor)

```
T√≠tulo: Administraci√≥n
√çcono: Settings
URL: (vac√≠o)
Item Padre: Ninguno
Orden: 10
```

### Crear sub-item (nivel 2)

```
T√≠tulo: Logs del Sistema
√çcono: FileText
URL: /admin/logs
Item Padre: Administraci√≥n
Orden: 1
```

### Item solo para superusuarios

```
T√≠tulo: Gesti√≥n de Tenants
√çcono: Building2
URL: /admin/tenants
Solo Superusuarios: ‚úì (marcado)
```

### Desactivar temporalmente un item

```
Editar el item
Activo: ‚òê (desmarcado)
Guardar
```

---

## üîê Seguridad

- ‚úÖ Todos los endpoints requieren autenticaci√≥n (`authWithTenant`)
- ‚úÖ Endpoints de escritura (POST/PUT/DELETE) requieren `superuser = true`
- ‚úÖ Filtrado autom√°tico por `tenantId` del usuario
- ‚úÖ Filtrado autom√°tico por `superuserOnly`
- ‚úÖ Validaci√≥n de permisos en backend
- ‚úÖ Confirmaci√≥n antes de eliminar items

---

## üéØ Funcionalidades Implementadas

- ‚úÖ Carga din√°mica del men√∫ desde BD
- ‚úÖ CRUD completo de items
- ‚úÖ Interfaz de administraci√≥n
- ‚úÖ Preview en tiempo real
- ‚úÖ Soporte multi-tenant
- ‚úÖ Control de permisos
- ‚úÖ Ordenamiento personalizable
- ‚úÖ **Drag & Drop para reordenar** (tanto padres como hijos)
- ‚úÖ Estados activo/inactivo
- ‚úÖ Jerarqu√≠a de 2 niveles
- ‚úÖ √çconos configurables
- ‚úÖ URLs configurables
- ‚úÖ Feedback visual durante arrastre

## ‚è≥ Pendiente (Futuro)

- ‚è∏Ô∏è Soporte para m√°s de 2 niveles
- ‚è∏Ô∏è Sistema de permisos granular por rol
- ‚è∏Ô∏è Duplicar items
- ‚è∏Ô∏è Importar/exportar configuraci√≥n de men√∫
- ‚è∏Ô∏è Historial de cambios

---

## üêõ Troubleshooting

### El men√∫ no aparece

1. Verificar que el backend est√© corriendo
2. Verificar que existe data en la tabla `menu_items`:
   ```sql
   SELECT COUNT(*) FROM menu_items WHERE "isActive" = true;
   ```
3. Ejecutar seed si no hay datos:
   ```bash
   cd backend && node src/seed/menu-items.js
   ```

### Los items de superusuario no aparecen

1. Verificar que el usuario est√© marcado como superusuario:
   ```sql
   SELECT id, nombre, apellido, superuser FROM users WHERE email = 'tu@email.com';
   ```
2. Si `superuser` es `false`, actualizar:
   ```sql
   UPDATE users SET superuser = true WHERE email = 'tu@email.com';
   ```

### El item se guarda pero no aparece

1. Verificar que `isActive = true`
2. Verificar que el usuario tenga permisos (si es `superuserOnly`)
3. Forzar recarga del men√∫ (F5 en navegador)

### Error "Item de men√∫ no encontrado"

El item fue eliminado de la BD. Verificar con:
```sql
SELECT * FROM menu_items WHERE id = 'el-id-del-item';
```

---

## üìù Notas Adicionales

- El men√∫ se cachea en memoria del componente para performance
- Los cambios en BD requieren refetch o recarga de p√°gina
- La eliminaci√≥n es en cascada (borra hijos autom√°ticamente)
- El orden se aplica ascendente (1, 2, 3...)
- Los items con `url = NULL` solo funcionan como contenedores

---

## üéì Arquitectura T√©cnica

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Frontend                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Sidebar.tsx                                     ‚îÇ
‚îÇ    ‚Üì useMenu()                                   ‚îÇ
‚îÇ  MenuAdminPage.tsx                               ‚îÇ
‚îÇ    ‚îú‚îÄ MenuItemsList.tsx                          ‚îÇ
‚îÇ    ‚îú‚îÄ MenuItemForm.tsx                           ‚îÇ
‚îÇ    ‚îî‚îÄ MenuPreview.tsx                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ HTTP (axios)
                 ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Backend                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  /api/menu (routes/menu.js)                     ‚îÇ
‚îÇ    ‚Üì authWithTenant                              ‚îÇ
‚îÇ  Prisma Client                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ SQL
                 ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              PostgreSQL                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  menu_items                                      ‚îÇ
‚îÇ    - Jerarqu√≠a (parentId)                        ‚îÇ
‚îÇ    - Multi-tenant (tenantId)                     ‚îÇ
‚îÇ    - Permisos (superuserOnly)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

**Sistema implementado exitosamente** ‚úÖ

√öltima actualizaci√≥n: 2025-01-24
